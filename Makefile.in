ifneq (,)
This Makefile requires GNU Make.
endif

top_srcdir := @top_srcdir@
top_builddir = .

prefix = @prefix@
exec_prefix = @exec_prefix@
libdir = @libdir@
includedir = @includedir@

# Where to install the library and object files.
ifndef libdir
libdir = $(exec_prefix)/lib
endif
inst_libdir = $(install_root)$(libdir)

# Where to install the header files.
ifndef includedir
includedir = $(prefix)/include
endif
inst_includedir = $(install_root)$(includedir)

dfp_name = @PACKAGE_NAME@
dfp_version = @PACKAGE_VERSION@

STATIC_LIB = @PACKAGE_NAME@.a

# The real library code: e.g. libdfp-1.0.0.so.
SHARED_REALNAME_LIB = @PACKAGE_NAME@-@PACKAGE_VERSION@.so

# The soname that symlinks to the real library code: e.g. libdfp.so.1.
# Traditionally the version number on the soname defined the 'interface'
# version.  Since this library intends to use symbol versioning there
# probably isn't ever a reason to move to .so.2 or later but we'll follow the
# precedent.
SHARED_SONAME_LIB = @PACKAGE_NAME@.so.1

# The linkername that symlinks to the soname: e.g. libdfp.so.  The linker looks for this name.
SHARED_LINKERNAME_LIB = @PACKAGE_NAME@.so

CC = @CC@
CXX = @CXX@
LDD = @LDD@
OBJDUMP = @OBJDUMP@
GDB = @GDB@
CXXFLAGS = @CXXFLAGS@ # This may be naive
CPPFLAGS = @CPPFLAGS@
RANLIB = @RANLIB@
AWK = @AWK@
LDCONFIG = /sbin/ldconfig

INSTALL := install

# libdecnumber or libbid
dfp_backend = @dfp_backend@
dfp_backend_lib = @dfp_backend@.a

# dpd or bid
dfp_encoding = @enable_decimal_float@

# e.g. powerpc
base_machine = @base_machine@
# e.g. powerpc32
machine = @machine@
# e.g. power6
submachine = @submachine@
# e.g. -mcpu=power6
submachine_opt = @submachine_opt@

# Necessary for z9-ec and z10 s390 platforms.
mzarch = @mzarch@

ifdef submachine_opt
cflags-cpu = $(submachine_opt)
asflags-cpu = $(submachine_opt)
endif

picflag = @picflag@

# Yes this is a bit of a hack, but gcc/libdecnumber/Makefile won't allow
# CFLAGS to be overridden on a submake invocation.
BACKEND_CFLAGS=
ifeq (libdecnumber, $(dfp_backend))
BACKEND_CFLAGS=$(cflags-cpu) $(picflag)
endif

default_cflags := @CFLAGS@
default_asflags := @ASFLAGS@

ifndef	+cflags
# Remove -I stuff from CFLAGS.
+cflags	:= $(filter-out -I%,$(default_cflags))
endif

# Add -mcpu=<CPU> targets and -f[pic|PIC].
+cflags	+= $(cflags-cpu) $(picflag)

# Don't duplicate options.
+cflags	:= $(sort $(+cflags))

override CFLAGS = $(gnu-inline-CFLAGS) $(+cflags)

# These are the flags given to the compiler to tell it what sort of
# optimization and/or debugging output to do for .S files.

ifndef	+asflags
# Remove -I stuff from ASFLAGS.
+asflags	:= $(filter-out -I%,$(default_asflags))
endif

# This makes sure -mcpu=CPU gets used when gcc is invoked against .S files.
# Also pull in CFLAGS so we get -m<size> options set by the configuration.
+asflags	+=  $(asflags-cpu) $(filter -g%,$(CFLAGS)) $(filter -m%,$(CFLAGS))

# Don't duplicate options.
+asflags	:= $(sort $(+asflags))

override ASFLAGS = $(+asflags)

sysdep_dirs = @sysdep_dirs@

# Strip of the trailing slashes on these
glibc_headers = $(patsubst %/,%,@glibc_headers@)
glibc_builddir = $(patsubst %/,%,@glibc_build@)

ifneq ( ,$(glibc_headers))
glibc_headers_dir = -isystem $(glibc_headers)
endif

# This is the precedence ordered list of subdirectories that configure
# selected for searching based upon submachine, machine, base_machine,
# dfp_encoding, and dfp_backend.  Add the ieee754r and decNumberMath
# convenience directories to the list.

# Find each sysdep directory or convenience directory with a Makefile in it.
makefile_dirs := $(foreach odir,$(sysdep_dirs), $(dir $(wildcard $(top_srcdir)/$(odir)/Makefile))) $(top_srcdir)/decNumberMath/ $(top_srcdir)/ieee754r/ $(top_srcdir)/base-math

# Like $makefile_dirs but add the $(top_srcdir) reference and strip out the redundant spaces.
# This has to be = assigned.
all_srcdirs = $(strip $(foreach dir,$(sysdep_dirs), $(top_srcdir)/$(dir))) $(top_srcdir)/decNumberMath/ $(top_srcdir)/ieee754r/ $(top_srcdir)/base-math $(top_srcdir)/ $(top_srcdir)/tests

# We need to add the $(dfp_backend) directories to the search path in order to
# pick up header files in those directories.
ifeq ($(dfp_backend),libdecnumber)
	# libdecnumber/bid or libdecnumber/dpd holds header files.
	backend_headers := $(dfp_backend)/$(dfp_encoding) $(dfp_backend)
else # libbid
	# TODO implement
	backend_headers :=
endif

# For header files we want to search every directory that is relevant.  We
# have to include $(top_builddir) in order to pick up the configure generated
# config.h.
system_header_dirs := dfp dfp/decimal

header_dirs := $(strip include $(system_header_dirs) $(backend_headers) $(sysdep_dirs) decNumberMath/ ieee754/ base-math/)

header_search_dirs := $(header_dirs:%=$(top_srcdir)/%) $(top_srcdir) $(top_builddir)

# GNU Make hack to reference a ' ' (space) character as the `from' function parameter in $(subst from,to,...).
sp :=
sp +=

# VPATH only needs to know the directory that source files are in.  Headers
# are searched based on -I precedence during the compilation invocation.
VPATH := $(subst $(sp),:,$(all_srcdirs))

# Files common to the $(top_srcdir).  These may be overriden in the sysdep
# directories and this list may have additional files added by sysdeps
# directory Makefiles which are included (not recursively invoked).
libdfp_files := dfptypeconv mapround decode fmt_d32 fmt_d64 fmt_d128 fe_decround \
		strtod32 strtod64 strtod128 wcstod32 wcstod64 wcstod128 \
		printf_dfp init_dfp

# The sysdeps subdirs aren't recursively invoked, they're included so that
# they can add files to the libdfp_files list.
include $(foreach dir,$(makefile_dirs), $(dir)/Makefile )

# Libdfp has a dependency on the backend so build that first.
all: first $(dfp_backend)/$(dfp_backend_lib) libdfp

# Fake rule to output the VPATH before we build anything.  Don't use .PHONY
# because we want this printed each time.
first:
	@echo VPATH=$(VPATH)
	@echo Processing Makefiles: $(makefile_dirs)

# Configure will have generated the Makefile for the selected backend.  Let's
# add it to the subdir list so it gets recursively invoked by Make.  Don't pass
# -e to make or it could pull unwanted variables from the environment.
# Yes, passing $(BACKEND_CFLAGS) in -DEFS is a hack, but since the
# libdecnumber maintainers won't allow CFLAGS to be overridden and the libdfp
# maintainer doesn't want to use libtool this hack will have to stand.
$(dfp_backend)/$(dfp_backend_lib):
	@echo "+Building DFP backend $@"
	DEFS="-D__STDC_DEC_FP__=200704L $(mzarch) $(BACKEND_CFLAGS)" $(MAKE) -C $(dfp_backend)
	@echo

libdfp: @enable_static@ @enable_shared@

static: $(top_builddir)/$(STATIC_LIB)

# Create the actual file with the version and the .so linker symlink.  The
# $(SHARED_SONAME_LIB) symlink is created by ldconfig be reading the `soname'
# from the SHARED_REALNAME_LIB.
shared: $(top_builddir)/$(SHARED_REALNAME_LIB) $(top_builddir)/$(SHARED_LINKERNAME_LIB) $(top_builddir)/$(SHARED_SONAME_LIB)
	@echo +Building shared lib and symlinks: $(notdir $^)

WARNS := -W -Wall -Wwrite-strings -Wstrict-prototypes -Wmissing-prototypes -Wold-style-definition -Wmissing-format-attribute -Wno-long-long
C_DEFINES := -D__STDC_DEC_FP__=200704L -D__STDC_WANT_DEC_FP__=1 -DOPTION_EGLIBC_LOCALE_CODE=1 -D_POSIX_C_SOURCE=200809L -std=gnu99 -D_SVID_SOURCE
ASM_DEFINES := -D__ELF__ -D__ASSEMBLER__ -DASSEMBLER -D__STDC_DEC_FP__=200704L -D__STDC_WANT_DEC_FP__=1 -DOPTION_EGLIBC_LOCALE_CODE=1
CXX_DEFINES := -D__STDC_DEC_FP__=200704L -D__STDC_WANT_DEC_FP__=1 -DOPTION_EGLIBC_LOCALE_CODE=1 -D_POSIX_C_SOURCE=200809L
CXX_WARNS := -W -Wall -Wwrite-strings -Wmissing-format-attribute -Wno-long-long

# Build the static object files.
.c.o:
	$(CC) $(CFLAGS) $(CPPFLAGS) $(mzarch) -c $< $(C_DEFINES) $(WARNS) -include $(top_srcdir)/include/libdfp-symbols.h -include $(top_builddir)/config.h $(foreach dir, $(header_search_dirs), -I$(dir)) $(glibc_headers_dir) -o $@
	@echo
.S.o:
	$(CC) $(CFLAGS) $(ASFLAGS) $(mzarch) -c $< $(ASM_DEFINES) $(WARNS) -include $(top_srcdir)/include/libdfp-symbols.h -include $(top_builddir)/config.h $(foreach dir, $(header_search_dirs), -I$(dir)) $(glibc_headers_dir) -o $@
	@echo

# Build the shared object files.
.c.os:
	$(CC) $(CFLAGS) $(CPPFLAGS) $(mzarch) -c $< $(C_DEFINES) $(WARNS) -include $(top_srcdir)/include/libdfp-symbols.h -include $(top_builddir)/config.h $(foreach dir, $(header_search_dirs), -I$(dir)) $(glibc_headers_dir) -o $@
	@echo

.S.os:
	$(CC) $(CFLAGS) $(ASFLAGS) $(mzarch) -c $< $(ASM_DEFINES) $(WARNS) -include $(top_srcdir)/include/libdfp-symbols.h -include $(top_builddir)/config.h $(foreach dir, $(header_search_dirs), -I$(dir)) $(glibc_headers_dir) -o $@
	@echo

# C++ compatibility test cases.
.cpp.os:
	$(CXX) $(CXXFLAGS) $(CPPFLAGS) $(mzarch) -c $< $(CXX_DEFINES) $(CXX_WARNS) -include $(top_srcdir)/include/libdfp-symbols.h -include $(top_builddir)/config.h $(foreach dir, $(header_search_dirs), -I$(dir)) $(glibc_headers_dir) -o $@
	@echo

# Archive the static library and include all of the .o files from the backend
# archive.  IF the backend has more than the base directory the .o detection
# mechanism will need to be more robust than this.
$(top_builddir)/$(STATIC_LIB): $(dfp_backend)/$(dfp_backend_lib) $(addsuffix .o,$(libdfp_files))
	@echo +Creating static library $@
	$(AR) rc $@ $(wordlist 2,$(words $^),$^) $(top_builddir)/$(dfp_backend)/*.o
	@ranlibpath=`which $(RANLIB)`; \
	if test -x "$$ranlibpath"; \
	then $(RANLIB) $@; fi;
	@echo

# Create libdfp.so -> libdfp.so.1 symlink.
$(top_builddir)/$(SHARED_LINKERNAME_LIB): $(top_builddir)/$(SHARED_REALNAME_LIB)
	@echo "+Creating linker .so symlink $(notdir $@) -> $(notdir $<)"
	ln -f -s $< $@
	@echo

# Create libdfp.so.1 -> libdfp-1.0.1.so symlink.
# The $(SHARED_SONAME_LIB) -> $(SHARED_REALNAME_LIB) symlink is supposed to
# be created by ldconfig be reading the `soname' from the SHARED_REALNAME_LIB.
$(top_builddir)/$(SHARED_SONAME_LIB): $(top_builddir)/$(SHARED_REALNAME_LIB)
	@echo "+Running ldconfig to create the library compat symlink $(notdir $@) -> $(notdir $<)"
	$(LDCONFIG) -l $(notdir $<)
	@echo

# Build the version tagged 'realname' shared object.  This requires that the
# $(dfp_name).map file be composed out of individual Versions files.  The
# -bsymbolic switch makes the library avoid using the PLT for intra-library
#  calls.
$(top_builddir)/$(SHARED_REALNAME_LIB): $(top_builddir)/$(dfp_name).map $(dfp_backend)/$(dfp_backend_lib) $(addsuffix .os,$(libdfp_files))
	@echo +Linking shared object files into $@.
	$(CC) $(CFLAGS) $(mzarch) -shared -Wl,-soname,$(SHARED_SONAME_LIB) -Bsymbolic -Wl,--whole-archive $(dfp_backend)/$(dfp_backend_lib) -Wl,--no-whole-archive -Wl,--version-script,$(dfp_name).map $(addsuffix .os,$(libdfp_files)) -o $@ -lm
	@echo

# The LIBDFP version script support is strongly based upon the GLIBC version
# script Makefile foo.  Thank you Roland McGrath and Ulrich Drepper!

# Versions.def defines the package versions.
$(top_builddir)/Versions.all: $(..)scripts/firstversions.awk \
			      $(top_srcdir)/Versions.def
	@echo +Creating $@ by running $(word 1,$^) against $(word 2,$^).
	{ cat $(word 2,$^); } | LC_ALL=C $(AWK) -f $< > $@T
	mv -f $@T $@
	@echo

# Versions.sysdeps is a concatenation of all of the sysdep directory Versions
# files (that accompany a Makefile) and run through sed to strip comments.  We
# use the wildcard function to verify that there actually is a Versions file
# accompanying a Makefile before we set it as a dependency.  Some sysdeps dirs
# only add internal interfaces.
$(top_builddir)/Versions.sysdeps: $(top_srcdir)/Versions $(wildcard $(makefile_dirs:%=%Versions))
	@echo +Scrubbing the following Versions files for comments and concatenating into a single $@ file.
	sed '/^[        ]*%/!s/#.*$$//;/^[      ]*$$/d;s/^[     ]*%/#/' $^ > $@T
	mv -f $@T $@
	@echo

move-if-change = $(SHELL) $(top_srcdir)/scripts/move-if-change

# This runs versions.awk and generates libdfp.map from the Versions.all and
# Versions.sysdeps files.
$(top_builddir)/sysd-versions: $(top_builddir)/Versions.all \
			    $(top_builddir)/Versions.sysdeps \
			    $(..)scripts/versions.awk
	@echo +The following invocation of $(word 3,$^) outputs $(dfp_name).map automagically.
	( echo 'sysd-versions-subdirs = $(strip $(top_srcdir)/ $(makefile_dirs))'; \
	  cat $(top_builddir)/$(word 2,$^) \
	  | LC_ALL=C $(AWK) -v buildroot="$(top_builddir)/" -v defsfile=$< \
			    -v move_if_change='$(move-if-change)' \
			    -f $(word 3,$^) \
	) > $@T
	mv $@T $@
	@echo

# This rule causes sysd-versions to be generated, which in turn invokes
# versions.awk which generates libdfp.map implicitly.
$(top_builddir)/libdfp.map: $(top_builddir)/sysd-versions

ifeq ($(glibc_builddir),)
# We might need -lpthread to test errno in TLS and to test TLS rounding mode
# or soft-dfp versions of libdfp.
#GLIBC_LIBS := -lc -lm -lpthread
GLIBC_LIBS := -lc -lm
else
#GLIBC_LIBS := $(glibc_builddir)/libc.so $(glibc_builddir)/math/libm.so $(glibc_builddir)/nptl/libpthread.so
GLIBC_LIBS := $(glibc_builddir)/libc.so $(glibc_builddir)/math/libm.so
endif

libdfp_c_tests = test-printf test-param test-amort test-decode test-quantize \
	       test-isnan test-isinf test-isfinite test-fpclassify test-logd \
	       test-log10d test-strtod test-numdigits test-get_digits \
	       test-round test-bfp-conversions test-stdlib test-wchar \
	       test-expd

libdfp_cxx_tests = test-ostream test-istream

libdfp_tests = $(libdfp_c_tests) $(libdfp_cxx_tests)

# Empty rule which simply makes the libdfp_tests .so's dependent on
# tests/scaffold.c so that when the scaffold file changes all of the test .so
# files are rebuilt since almost all of them depend on the scaffold anyway.
$(addsuffix .os, $(libdfp_tests)): $(top_srcdir)/tests/scaffold.c

# The CPP test rely on the <dfp/decimal> header.  If that changes then they
# need to be rebuilt.
$(addsuffix .os, $(libdfp_cxx_tests)): $(top_srcdir)/dfp/decimal/decimal $(top_srcdir)/dfp/float.h

# Explicitly link against the uninstalled GLIBC and the Libdfp.so.1 we just
# built.
$(libdfp_c_tests): %:%.os $(top_builddir)/$(SHARED_SONAME_LIB)
	$(CC) $(CFLAGS) $(mzarch) $(GLIBC_LIBS) -L$(top_builddir)/ -ldfp $(top_builddir)/$(addsuffix .os,$@) -o $@
	@echo

# Explicitly link against the uninstalled GLIBC and the Libdfp.so.1 we just
# built.
$(libdfp_cxx_tests): %:%.os $(top_builddir)/$(SHARED_SONAME_LIB)
	$(CXX) $(CXXFLAGS) $(mzarch) $(GLIBC_LIBS) -L$(top_builddir)/ -ldfp $(top_builddir)/$(addsuffix .os,$@) -o $@
	@echo

LIBRARY_PATH = $(glibc_builddir)/:$(glibc_builddir)/math:$(glibc_builddir)/elf:$(glibc_builddir)/nptl

# Invoke the GLIBC loader and tell it to run the application.  Also make sure
# the .gdb files are generated before the tests are run so that they get
# generated even if the tests fail.  Stderr is piped to the .out file while
# stdout is dumped to /dev/null.
$(addsuffix .out,$(libdfp_tests)): %.out:% %.gdb
ifneq ($(glibc_builddir),)
	ulimit -c unlimited; \
	GCONV_PATH=$(glibc_builddir)/iconvdata LC_ALL=C \
	$(glibc_builddir)/elf/ld.so --library-path \
	$(LIBRARY_PATH):$(top_builddir) \
	$(top_builddir)/$(patsubst %.out,%,$@) \
	2> $(top_builddir)/$@ 1> /dev/null
	@echo
else
	LD_LIBRARY_PATH=$(top_builddir)/:$$LD_LIBRARY_PATH $(top_builddir)/$(patsubst %.out,%,$@) 2> $(top_builddir)/$@ 1> /dev/null
	@echo
endif

DISTCLEANFILES = $(top_builddir)/debug-test.conf

# The following rules are defined in Makefile.gdb:
#	$(top_builddir)/debug-test.conf:
#	$(addsuffix .conf,$(libdfp_tests)):
#	$(addsuffix .gdb,$(libdfp_tests)):
include $(top_srcdir)/Makefile.gdb

# We use debug-test.conf as an input file for some debugging utilities.  The
# .out files are predicated in another rule on the actual test executables, so
# those are built from those rules.
check: $(top_builddir)/debug-test.conf $(addsuffix .conf,$(libdfp_tests)) $(addsuffix .out,$(libdfp_tests))
	@echo +Completed make check

.PHONY: check

clean:
	rm *.o *.os $(STATIC_LIB) $(SHARED_LINKERNAME_LIB) $(SHARED_SONAME_LIB) $(SHARED_REALNAME_LIB) Versions.all Versions.sysdeps libdfp.map Versions.tmp sysd-versions $(top_builddir)/$(dfp_backend)/*.o $(top_builddir)/$(dfp_backend)/*.a debug-test.conf $(addsuffix .out,$(libdfp_tests)) $(addsuffix .conf,$(libdfp_tests)) $(addsuffix .gdb,$(libdfp_tests)) $(libdfp_tests)

.PHONY: clean

install: all
	$(INSTALL) -d $(inst_libdir)
ifeq ("@enable_static@","static")
	$(INSTALL) -t $(inst_libdir) $(top_builddir)/$(STATIC_LIB)
endif
	$(INSTALL) -t $(inst_libdir) $(top_builddir)/$(SHARED_REALNAME_LIB)
	ln -f -s $(SHARED_REALNAME_LIB) $(inst_libdir)/$(SHARED_LINKERNAME_LIB)
	$(LDCONFIG) -l $(inst_libdir)/$(SHARED_REALNAME_LIB)
	$(INSTALL) -d $(inst_includedir)
	$(INSTALL) -d $(inst_includedir)/dfp
	$(INSTALL) -d $(inst_includedir)/dfp/decimal
	$(INSTALL) -t $(inst_includedir)/dfp $(top_srcdir)/dfp/*.h
	$(INSTALL) -t $(inst_includedir)/dfp/decimal/ $(top_srcdir)/dfp/decimal/*
.PHONY: install

install-headers:
	$(INSTALL) -d $(inst_includedir)
	$(INSTALL) -d $(inst_includedir)/dfp
	$(INSTALL) -d $(inst_includedir)/dfp/decimal
	$(INSTALL) -t $(inst_includedir)/dfp $(top_srcdir)/dfp/*.h
	$(INSTALL) -t $(inst_includedir)/dfp/decimal/ $(top_srcdir)/dfp/decimal/*
.PHONY: install-headers

# Clean out the existing .SUFFIXES setting.
.SUFFIXES:
# Prioritize .S over .c when searching for target files.  The .os suffix
# is used for shared object file and the .o suffix is for static object files.
.SUFFIXES: .S .c .cpp .o .os
